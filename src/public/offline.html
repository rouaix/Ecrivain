<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lecture hors-ligne — Ecrivain</title>
    <link rel="stylesheet" href="style.css">
    <link id="theme-css" rel="stylesheet" href="theme-default.css">
    <link rel="stylesheet" href="reading.css">
    <style>
        .offline-wrapper {
            max-width: 800px;
            margin: 0 auto;
            padding: 40px 20px;
        }

        .offline-page-header {
            margin-bottom: 30px;
        }

        .offline-page-header h1 {
            font-size: 1.8rem;
            margin: 0 0 8px 0;
            color: var(--text-main);
        }

        .offline-page-header p {
            color: var(--text-muted);
            margin: 0;
        }

        .offline-project-list {
            list-style: none;
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .offline-project-card {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px 20px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            background: var(--card-bg);
            cursor: pointer;
            transition: background 0.15s;
        }

        .offline-project-card:hover {
            background: var(--table-row-bg);
        }

        .offline-project-card strong {
            font-size: 1.05rem;
            color: var(--text-main);
        }

        .offline-project-meta {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: 4px;
        }

        .offline-date {
            font-size: 0.8em;
            color: var(--text-muted);
        }

        .offline-open-hint {
            font-size: 0.8em;
            color: var(--link-color);
        }

        .offline-empty {
            padding: 40px 20px;
            text-align: center;
            color: var(--text-muted);
            border: 1px dashed var(--border-color);
            border-radius: 8px;
        }

        .offline-empty p {
            margin: 6px 0;
        }

        .offline-empty .offline-empty-path {
            font-family: monospace;
            background: var(--table-header-bg);
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 0.9em;
        }

        .offline-delete-btn {
            background: none;
            border: none;
            color: var(--text-muted);
            cursor: pointer;
            font-size: 1rem;
            padding: 4px 8px;
            border-radius: 4px;
            line-height: 1;
        }

        .offline-delete-btn:hover {
            color: var(--rouge, #c0392b);
            background: var(--table-header-bg);
        }

        /* Reader view — only flex when not hidden (hidden attr must not be overridden) */
        #view-reader:not([hidden]) {
            display: flex;
            flex-direction: column;
            height: 100vh;
        }

        .offline-toolbar {
            background: var(--header-bg);
            color: var(--header-text);
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 10px 20px;
            position: sticky;
            top: 0;
            z-index: 100;
            flex-shrink: 0;
        }

        .offline-toolbar .toolbar-title {
            flex: 1;
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--header-text);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .offline-toolbar .toolbar-btn {
            background: rgba(255,255,255,0.12);
            color: var(--header-text);
            border: 1px solid rgba(255,255,255,0.25);
            padding: 6px 14px;
            border-radius: 4px;
            cursor: pointer;
            font-family: inherit;
            font-size: 0.85rem;
            white-space: nowrap;
        }

        .offline-toolbar .toolbar-btn:hover {
            background: rgba(255,255,255,0.2);
        }

        .offline-toolbar .offline-saved-date {
            font-size: 0.75rem;
            opacity: 0.65;
            white-space: nowrap;
        }
    </style>
</head>
<body>

    <!-- Liste des projets sauvegardés -->
    <div id="view-list">
        <div class="offline-wrapper">
            <div class="offline-page-header">
                <h1>Lecture hors-ligne</h1>
                <p>Projets enregistres dans ce navigateur (IndexedDB). Aucune connexion requise.</p>
            </div>
            <div id="project-list">
                <p style="color:var(--text-muted)">Chargement...</p>
            </div>
        </div>
    </div>

    <!-- Lecteur -->
    <div id="view-reader" hidden>
        <div class="offline-toolbar">
            <button class="toolbar-btn" id="btn-back">&#8592; Retour</button>
            <span class="toolbar-title" id="reader-title"></span>
            <span class="offline-saved-date" id="reader-date"></span>
        </div>
        <div class="reading-container" style="flex:1;overflow-y:auto">
            <main class="reading-content" id="reader-content"></main>
        </div>
    </div>

    <script src="js/offline-reader.js"></script>
    <script>
    (function () {
        // Apply theme from cookie
        var themeCookie = document.cookie.match(/(?:^|;\s*)theme=([^;]+)/);
        var theme = (themeCookie && themeCookie[1]) || 'default';
        var validThemes = ['default', 'dark', 'blue', 'forest', 'moderne'];
        if (validThemes.indexOf(theme) === -1) theme = 'default';
        document.getElementById('theme-css').href = 'theme-' + theme + '.css';
        document.body.className = 'reading-mode theme-' + theme;

        var viewList   = document.getElementById('view-list');
        var viewReader = document.getElementById('view-reader');
        var projectListEl = document.getElementById('project-list');
        var readerContent = document.getElementById('reader-content');
        var readerTitle   = document.getElementById('reader-title');
        var readerDate    = document.getElementById('reader-date');
        var btnBack       = document.getElementById('btn-back');

        function esc(s) {
            return String(s)
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;');
        }

        function formatDate(iso) {
            try { return new Date(iso).toLocaleString('fr-FR'); }
            catch (e) { return iso; }
        }

        function loadList() {
            if (!window.OfflineReader) {
                projectListEl.innerHTML = '<div class="offline-empty"><p>IndexedDB non disponible dans ce navigateur.</p></div>';
                return;
            }

            OfflineReader.listProjects().then(function (projects) {
                if (!projects || projects.length === 0) {
                    projectListEl.innerHTML = [
                        '<div class="offline-empty">',
                        '<p>Aucun projet sauvegarde.</p>',
                        '<p>Pour sauvegarder : ouvrez un projet &rarr; mode Lecture &rarr; bouton <strong>Hors-ligne</strong>.</p>',
                        '</div>'
                    ].join('');
                    return;
                }

                projects.sort(function (a, b) {
                    return (b.savedAt || '').localeCompare(a.savedAt || '');
                });

                var html = '<ul class="offline-project-list">';
                projects.forEach(function (p) {
                    html += '<li class="offline-project-card" data-id="' + esc(p.id) + '">';
                    html += '<strong>' + esc(p.title) + '</strong>';
                    html += '<div class="offline-project-meta">';
                    html += '<span class="offline-date">Sauvegarde le ' + formatDate(p.savedAt) + '</span>';
                    html += '<span class="offline-open-hint">Cliquer pour lire &rarr;</span>';
                    html += '</div>';
                    html += '<button class="offline-delete-btn" data-delete-id="' + esc(p.id) + '" title="Supprimer du cache">&#x2715;</button>';
                    html += '</li>';
                });
                html += '</ul>';
                projectListEl.innerHTML = html;

                document.querySelectorAll('.offline-project-card').forEach(function (card) {
                    card.addEventListener('click', function (e) {
                        if (e.target.closest('.offline-delete-btn')) return;
                        openProject(card.dataset.id);
                    });
                });

                document.querySelectorAll('.offline-delete-btn').forEach(function (btn) {
                    btn.addEventListener('click', function (e) {
                        e.stopPropagation();
                        if (confirm('Supprimer ce projet du cache hors-ligne ?')) {
                            OfflineReader.deleteProject(btn.dataset.deleteId).then(loadList);
                        }
                    });
                });

            }).catch(function () {
                projectListEl.innerHTML = '<div class="offline-empty"><p>Erreur lors de la lecture du cache.</p></div>';
            });
        }

        function openProject(id) {
            OfflineReader.loadProject(id).then(function (p) {
                if (!p) {
                    alert('Projet introuvable dans le cache.');
                    return;
                }
                readerTitle.textContent = p.title;
                readerDate.textContent  = 'Sauvegarde le ' + formatDate(p.savedAt);
                readerContent.innerHTML = p.html;

                viewList.hidden   = true;
                viewReader.hidden = false;
                window.scrollTo(0, 0);
            });
        }

        btnBack.addEventListener('click', function () {
            viewReader.hidden = false;
            viewList.hidden   = true;

            viewReader.hidden  = true;
            viewList.hidden    = false;
            readerContent.innerHTML = '';
        });

        loadList();
    })();
    </script>
</body>
</html>
