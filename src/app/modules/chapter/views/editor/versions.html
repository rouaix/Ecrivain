<div class="edit-page-layout">
    <div class="edit-header">
        <h2><i class="fas fa-history"></i> Historique des versions</h2>
        <a href="{{ @base }}/chapter/{{ @chapter.id }}" class="button" title="Retour à l'éditeur">
            <i class="fas fa-arrow-left"></i>
        </a>
    </div>

    <div class="edit-card">
        <p style="margin: 0 0 16px; color: var(--text-muted, #777); font-size: .88rem;">
            Chapitre&nbsp;: <strong>{{ @chapter.title | esc }}</strong> &mdash;
            Les 10 dernières sauvegardes sont conservées.
        </p>

        <check if="{{ empty(@versions) }}">
            <p style="color: var(--text-muted, #777);">Aucune version enregistrée pour ce chapitre.</p>
        </check>

        <check if="{{ !empty(@versions) }}">
            <div class="versions-list">
                <repeat group="{{ @versions }}" value="{{ @v }}" counter="{{ @i }}">
                    <div class="version-item">
                        <div class="version-meta">
                            <span class="version-num">Version {{ @i }}</span>
                            <span class="version-date">{{ @v.created_at }}</span>
                            <span class="version-words">{{ number_format(@v.word_count, 0, ',', '\u{202f}') }} mots</span>
                        </div>
                        <div class="version-actions">
                            <button type="button" class="button secondary btn-preview"
                                data-vid="{{ @v.id }}"
                                data-cid="{{ @chapter.id }}"
                                data-label="Version {{ @i }} — {{ @v.created_at }}">
                                <i class="fas fa-eye"></i>
                            </button>
                            <form method="post" action="{{ @base }}/chapter/{{ @chapter.id }}/restore/{{ @v.id }}"
                                  onsubmit="return confirm('Restaurer cette version ? Le contenu actuel sera remplacé.');">
                                <input type="hidden" name="csrf_token" value="{{ @csrfToken }}">
                                <button type="submit" class="button secondary">
                                    <i class="fas fa-undo" style="margin-right: 6px;"></i>Restaurer
                                </button>
                            </form>
                            <form method="post" action="{{ @base }}/chapter/{{ @chapter.id }}/version/{{ @v.id }}/delete"
                                  onsubmit="return confirm('Supprimer définitivement cette version ?');">
                                <input type="hidden" name="csrf_token" value="{{ @csrfToken }}">
                                <button type="submit" class="button small delete" title="Supprimer">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </form>
                        </div>
                    </div>
                </repeat>
            </div>
        </check>
    </div>
</div>

<!-- Modale prévisualisation -->
<div class="modal-overlay" id="versionPreviewModal">
    <div class="modal-content" style="max-width: 800px; max-height: 85vh; display: flex; flex-direction: column;">
        <div class="modal-header">
            <h3 id="versionPreviewTitle"><i class="fas fa-eye"></i> Prévisualisation</h3>
            <button type="button" class="modal-close" id="closeVersionPreview">&times;</button>
        </div>
        <div class="modal-body" style="flex: 1; overflow-y: auto;">
            <div id="versionPreviewMeta" style="margin-bottom: 12px; font-size: .85rem; color: var(--text-muted, #777);"></div>
            <div id="versionPreviewContent" class="ql-editor" style="border: 1px solid var(--border-color, #e0e0e0); border-radius: 6px; padding: 16px; min-height: 200px; background: var(--card-bg, #fff);"></div>
        </div>
    </div>
</div>

<style nonce="{{ @nonce }}">
.versions-list { display: flex; flex-direction: column; gap: 8px; }
.version-item {
    display: flex; align-items: center; justify-content: space-between;
    padding: 12px 16px;
    border: 1px solid var(--border-color, #e0e0e0);
    border-radius: 8px;
    background: var(--card-bg, #fff);
}
.version-meta { display: flex; align-items: center; gap: 16px; flex-wrap: wrap; }
.version-num  { font-weight: 600; color: var(--text-main, #333); min-width: 70px; }
.version-date { color: var(--text-muted, #777); font-size: .85rem; }
.version-words { color: var(--text-muted, #777); font-size: .85rem; }
.version-actions { display: flex; align-items: center; gap: 8px; flex-shrink: 0; }
.version-actions form { margin: 0; }
</style>

<script nonce="{{ @nonce }}">
(function () {
    var modal   = document.getElementById('versionPreviewModal');
    var title   = document.getElementById('versionPreviewTitle');
    var meta    = document.getElementById('versionPreviewMeta');
    var content = document.getElementById('versionPreviewContent');
    var base    = '{{ @base }}';

    function openModal() { modal.classList.add('is-visible'); }
    function closeModal() { modal.classList.remove('is-visible'); }

    document.getElementById('closeVersionPreview').addEventListener('click', closeModal);
    modal.addEventListener('click', function (e) { if (e.target === modal) closeModal(); });
    document.addEventListener('keydown', function (e) {
        if (e.key === 'Escape' && modal.classList.contains('is-visible')) closeModal();
    });

    document.querySelectorAll('.btn-preview').forEach(function (btn) {
        btn.addEventListener('click', function () {
            var vid   = btn.dataset.vid;
            var cid   = btn.dataset.cid;
            var label = btn.dataset.label;

            title.innerHTML   = '<i class="fas fa-eye"></i> ' + label;
            meta.textContent  = 'Chargement…';
            content.innerHTML = '';
            openModal();

            fetch(base + '/chapter/' + cid + '/version/' + vid + '/preview')
                .then(function (r) { return r.json(); })
                .then(function (data) {
                    if (data.error) {
                        meta.textContent  = '';
                        content.innerHTML = '<p style="color:#ef4444">' + data.error + '</p>';
                        return;
                    }
                    meta.textContent  = data.word_count + ' mots';
                    content.innerHTML = data.content;
                })
                .catch(function () {
                    meta.textContent  = '';
                    content.innerHTML = '<p style="color:#ef4444">Erreur réseau.</p>';
                });
        });
    });
}());
</script>
