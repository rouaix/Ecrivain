<!-- Chapters -->

<section class="panel panel-open">

  <div class="panel-heading">

    <div>

      <h3>Actes et Chapitres</h3>

      <p class="panel-subtitle">Structure principale du r&eacute;cit.</p>

    </div>

    <div class="panel-actions">

      <a class="button" href="{{ @base }}/project/{{ @project.id }}/act/create" title="Ajouter un acte"><i
          class="fas fa-folder-plus"></i></a>

      <a class="button" href="{{ @base }}/project/{{ @project.id }}/chapter/create" title="Ajouter un chapitre"><i
          class="fas fa-plus"></i></a>

    </div>

  </div>

  <check if="{{ empty(@acts) && empty(@chaptersWithoutAct) }}">

    <true>

      <p>Aucun chapitre ou acte pour ce projet.</p>

    </true>

    <false>

      <repeat group="{{ @acts }}" value="{{ @act }}">

        <details class="act-container" id="act-{{ @act.id }}" data-persist="true">

          <summary class="act-summary">

            <h4>

              <input type="checkbox" class="export-toggle js-stop-propagation" data-type="act" data-id="{{ @act.id }}"
                {{ @act.is_exported_attr }} title="Inclure dans l'export">

              <input type="number" class="order-input js-stop-propagation" data-type="act" data-id="{{ @act.id }}"
                value="{{ @act.order_index + 1 }}">

              {{ @act.title }}

              <span class="act-meta">

                ({{ @act.stats_chapters }} chapitres / {{ @act.stats_pages }} pages)

              </span>

            </h4>

            <div class="act-actions">

              <button class="button small ai-act-summary-btn js-stop-propagation" data-id="{{ @act.id }}"
                title="R&eacute;sum&eacute; IA"><i class="fas fa-magic"></i></button>

              <a class="button small js-stop-propagation" href="{{ @base }}/act/{{ @act.id }}/edit"
                title="Modifier l'acte"><i class="fas fa-edit"></i></a>

              <a class="button small delete js-confirm js-stop-propagation" href="{{ @base }}/act/{{ @act.id }}/delete"
                data-confirm="Supprimer cet acte et tous ses chapitres ?" title="Supprimer"><i
                  class="fas fa-trash"></i></a>

            </div>

          </summary>

          <check if="{{ !empty(@act.resume) }}">

            <div class="act-resume">

              <strong>R&eacute;sum&eacute; :</strong><br />

              {{ @act.resume | raw }}

            </div>

          </check>

          <check if="{{ !empty(@act.comment)}}">

            <div class="act-comment">

              <span>Remarques : </span>{{ @act.comment }}

            </div>

          </check>

          <check if="{{ !isset(@chaptersByAct[@act.id]) }}">

            <true>

              <p>Aucun chapitre dans cet acte.</p>

            </true>

            <false>

              <details class="act-chapters" id="act-chapters-{{ @act.id }}" data-persist="true">

                <summary>Chapitres de l'acte <span class="panel-count">{{

                    count(@chaptersByAct[@act.id]) }}</span></summary>

                <table class="data-table chapitres">

                  <thead>

                    <tr>

                      <th>Titre</th>

                      <th class="stats">Stats</th>

                      <th class="actions">Actions</th>

                    </tr>

                  </thead>

                  <tbody class="sortable-chapters">

                    <repeat group="{{ @chaptersByAct[@act.id] }}" value="{{ @ch }}">

                      <tr data-id="{{ @ch.id }}">

                        <td class="chapter-actions">

                          <input type="checkbox" class="export-toggle" data-type="chapter" data-id="{{ @ch.id }}" {{
                            @ch.is_exported_attr }} title="Inclure dans l'export">

                          <input type="number" class="order-input" data-type="chapter" data-id="{{ @ch.id }}"
                            value="{{ @ch.order_index + 1 }}">

                          <check if="{{ count(@ch.subs) > 0 }}">

                            <span class="collapse-toggle" data-target="{{ @ch.id }}">&#9660;</span>

                          </check>

                          <strong>

                            {{ @ch.title }}

                          </strong>

                          <check if="{{ !empty(@ch.resume) }}">

                            <div class="chapter-resume">

                              <strong>R&eacute;sum&eacute; :</strong><br>

                              {{ @ch.resume | raw }}

                            </div>

                          </check>

                          <check if="{{ !empty(@ch.comment)}}">

                            <div class="chapter-comment">

                              <span>Remarques : </span>{{ @ch.comment | raw }}

                            </div>

                          </check>

                        </td>

                        <td class="stats">

                          {{ @ch.total_wc }} mots<br>{{ @ch.total_lines }}

                          lignes

                          <br>{{

                          @ch.total_pages }}

                          pages

                        </td>

                        <td class="actions">

                          <a class="button small"
                            href="{{ @base }}/project/{{ @project.id }}/chapter/create?parent_id={{ @ch.id }}&act_id={{ @ch.act_id }}"
                            title="+ Sous-chapitre">

                            <i class="fas fa-plus"></i></a>

                          <button class="button small ai-summary-btn" data-id="{{ @ch.id }}" title="R&eacute;sum&eacute; IA"><i
                              class="fas fa-magic"></i></button><br />

                          <button class="button small preview-btn" data-type="chapter" data-id="{{ @ch.id }}"
                            title="Voir"><i class="fas fa-eye"></i></button>

                          <a class="button small" href="{{ @base }}/chapter/{{ @ch.id }}" title="&Eacute;diter"><i
                              class="fas fa-edit"></i></a>

                          <a class="button small delete js-confirm" href="{{ @base }}/chapter/{{ @ch.id }}/delete"
                            data-confirm="Supprimer ce chapitre ?" title="Supprimer"><i class="fas fa-trash"></i></a>

                        </td>

                      </tr>

                      <repeat group="{{ @ch.subs }}" value="{{ @sub }}">

                        <tr data-id="{{ @sub.id }}" class="sub-chapter sub-of-{{ @ch.id }}">

                          <td class="sous-chapitre">

                            <input type="checkbox" class="export-toggle" data-type="chapter" data-id="{{ @sub.id }}" {{
                              @sub.is_exported_attr }} title="Inclure dans l'export">

                            <input type="number" class="order-input" data-type="chapter" data-id="{{ @sub.id }}"
                              value="{{ @sub.order_index + 1 }}">

                            <span>

                              {{ @sub.title }}

                            </span>

                            <check if="{{ !empty(@sub.comment)}}">

                              <div class="sub-chapter-comment">

                                <span>Remarques : </span>{{ @sub.comment | raw }}

                              </div>

                            </check>

                          </td>

                          <td class="stats">

                            {{ @sub.wc }} mots<br>{{

                            @sub.lines }} lignes

                            <br>{{ @sub.pages }}

                            pages

                          </td>

                          <td class="actions">

                            <button class="button small preview-btn" data-type="chapter" data-id="{{ @sub.id }}"
                              title="Voir"><i class="fas fa-eye"></i></button>

                            <a class="button small" href="{{ @base }}/chapter/{{ @sub.id }}" title="&Eacute;diter"><i
                                class="fas fa-edit"></i></a>

                            <a class="button small delete js-confirm" href="{{ @base }}/chapter/{{ @sub.id }}/delete"
                              data-confirm="Supprimer ce sous-chapitre ?" title="Supprimer"><i
                                class="fas fa-trash"></i></a>

                          </td>

                        </tr>

                      </repeat>

                    </repeat>

                  </tbody>

                </table>

              </details>

            </false>

          </check>

        </details>

      </repeat>

      <check if="{{ !empty(@chaptersWithoutAct) }}">

        <details class="act-container" id="act-orphan" data-persist="true">

          <summary class="act-summary">

            <h4>

              Acte ?

              <span class="act-meta">

                ({{ @orphanStats.chapters }} chapitres / {{ @orphanStats.pages }} pages)

              </span>

            </h4>

          </summary>

          <div class="act-description">

            Chapitres hors actes

          </div>

          <details class="act-chapters" id="act-orphan-chapters" data-persist="true" open>

            <summary>Chapitres de l'acte <span class="panel-count">{{ count(@chaptersWithoutAct)

                }}</span></summary>

            <table class="data-table chapitres">

              <thead>

                <tr>

                  <th>Titre</th>

                  <th class="stats">Stats</th>

                  <th class="actions">Actions</th>

                </tr>

              </thead>

              <tbody class="sortable-chapters">

                <repeat group="{{ @chaptersWithoutAct }}" value="{{ @ch }}">

                  <tr data-id="{{ @ch.id }}">

                    <td class="chapter-actions">

                      <input type="checkbox" class="export-toggle" data-type="chapter" data-id="{{ @ch.id }}" {{
                        @ch.is_exported_attr }} title="Inclure dans l'export">

                      <input type="number" class="order-input" data-type="chapter" data-id="{{ @ch.id }}"
                        value="{{ @ch.order_index + 1 }}">

                      <check if="{{ count(@ch.subs) > 0 }}">

                        <span class="collapse-toggle" data-target="{{ @ch.id }}">&#9660;</span>

                      </check>

                      {{ @ch.title }}

                      <check if="{{ !empty(@ch.resume) }}">

                        <div class="chapter-resume">

                          <strong>R&eacute;sum&eacute; :</strong><br>

                          {{ @ch.resume | raw }}

                        </div>

                      </check>

                      <check if="{{ !empty(@ch.comment)}}">

                        <div class="chapter-comment">

                          <span>Remarques : </span>{{ @ch.comment | raw }}

                        </div>

                      </check>

                    </td>

                    <td>

                      {{ @ch.total_wc }} mots<br>{{ @ch.total_lines }}

                      lignes<br>{{@ch.total_pages }} pages

                      <check if="{{ @ch.wc_subs_only > 0 }}">

                        <br>({{ @ch.wc }} + {{

                        @ch.wc_subs_only

                        }})

                      </check>

                    </td>

                    <td class="actions">

                      <a class="button small"
                        href="{{ @base }}/project/{{ @project.id }}/chapter/create?parent_id={{ @ch.id }}&act_id={{ @ch.act_id }}"
                        title="+ Sous-chapitre">

                        <i class="fas fa-plus"></i></a>

                      <button class="button small ai-summary-btn" data-id="{{ @ch.id }}" title="R&eacute;sum&eacute; IA"><i
                          class="fas fa-magic"></i></button><br />

                      <button class="button small preview-btn" data-type="chapter" data-id="{{ @ch.id }}"
                        title="Voir"><i class="fas fa-eye"></i></button>

                      <a class="button small" href="{{ @base }}/chapter/{{ @ch.id }}" title="&Eacute;diter"><i
                          class="fas fa-edit"></i></a>

                      <a class="button small delete js-confirm" href="{{ @base }}/chapter/{{ @ch.id }}/delete"
                        data-confirm="Supprimer ce chapitre ?" title="Supprimer"><i class="fas fa-trash"></i></a>

                    </td>

                  </tr>

                  <repeat group="{{ @ch.subs }}" value="{{ @sub }}">

                    <tr data-id="{{ @sub.id }}" class="sub-chapter sub-of-{{ @ch.id }}">

                      <td class="sous-chapitre">

                        <input type="checkbox" class="export-toggle" data-type="chapter" data-id="{{ @sub.id }}" {{
                          @sub.is_exported_attr }} title="Inclure dans l'export">

                        <input type="number" class="order-input" data-type="chapter" data-id="{{ @sub.id }}"
                          value="{{ @sub.order_index + 1 }}">

                        <span>{{ @sub.title }}</span>

                        <check if="{{ !empty(@sub.comment)}}">

                          <div class="sub-chapter-comment">

                            <span>Remarques : </span>{{ @sub.comment | raw }}

                          </div>

                        </check>

                      </td>

                      <td class="stats">

                        {{ @sub.wc }} mots<br>{{ @sub.lines }} lignes

                        <br>{{ @sub.pages }} pages

                      </td>

                      <td class="actions">

                        <button class="button small preview-btn" data-type="chapter" data-id="{{ @sub.id }}"
                          title="Voir"><i class="fas fa-eye"></i></button>

                        <a class="button small" href="{{ @base }}/chapter/{{ @sub.id }}" title="&Eacute;diter"><i
                            class="fas fa-edit"></i></a>

                        <a class="button small delete js-confirm" href="{{ @base }}/chapter/{{ @sub.id }}/delete"
                          data-confirm="Supprimer ce sous-chapitre ?" title="Supprimer"><i class="fas fa-trash"></i></a>

                      </td>

                    </tr>

                  </repeat>

                </repeat>

              </tbody>

            </table>

          </details>

        </details>

      </check>

    </false>

  </check>

</section>
