<h2>Bonjour {{ @user.username }}!</h2>
<p>Voici la liste de vos projets d’écriture. Vous pouvez créer un nouveau projet ou gérer les projets existants.</p>
<a class="button" href="{{ @base }}/project/create">Nouveau projet</a>
<a class="button" href="{{ @base }}/profile">Mon Profil</a>
<a class="button" href="{{ @base }}/ai/config" class="button-ai-purple">Configuration IA</a>
<a class="button secondary" href="{{ @base }}/ai/usage">Consommation IA</a>
</p>
<check if="{{ empty(@projects) }}">
    <true>
        <p>Vous n’avez aucun projet pour le moment.</p>
    </true>
    <false>
        <table class="data-table">
            <thead>
                <tr>
                    <th>Titre</th>
                    <th>Objectif (mots)</th>
                    <th>Pages estimées</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                <repeat group="{{ @projects }}" value="{{ @proj }}">
                    <tr>
                        <td>{{ @proj.title }}</td>
                        <td>{{ @proj.target_words }}</td>
                        <td>{{ @proj.pages_count }}</td>
                        <td>
                            <a class="button" href="{{ @base }}/project/{{ @proj.id }}">Ouvrir</a>
                            <a class="button" href="{{ @base }}/project/{{ @proj.id }}/edit">Modifier</a>
                            <a class="button delete is-hidden"
                                href="{{ @base }}/project/{{ @proj.id }}/delete"
                                onclick="return confirm('Supprimer ce projet ?');">Supprimer</a>
                        </td>
                    </tr>
                </repeat>
            </tbody>
        </table>
    </false>
</check>

<div class="card-panel">
    <h3>Accès rapide</h3>
    <p>Générer un lien d'auto-login pour votre compte.</p>
    <button id="btn-generate-token" class="button" onclick="generateToken()">Générer un lien</button>

    <div class="mt-20">
        <h4>Vos liens actifs</h4>
        <div id="token-list" class="mt-10">
            <p>Chargement...</p>
        </div>
    </div>
</div>

<div class="card-panel">
    <h3>Apparence</h3>
    <p>Choisissez le thème de l'interface.</p>
    <form action="{{ @base }}/theme" method="post" class="theme-form">
        <input type="hidden" name="csrf_token" value="{{ @csrfToken }}">

        <!-- Light Themes -->
        <button type="submit" name="theme" value="default" class="button theme-button theme-button--default">Défaut (Bleu)</button>
        <button type="submit" name="theme" value="modern" class="button theme-button theme-button--modern">Moderne (Vert)</button>
        <button type="submit" name="theme" value="paper" class="button theme-button theme-button--paper">Papier (Sépia)</button>

        <!-- Dark Themes -->
        <button type="submit" name="theme" value="dark" class="button theme-button theme-button--dark">Sombre (Gris)</button>
        <button type="submit" name="theme" value="midnight" class="button theme-button theme-button--midnight">Minuit (Bleu)</button>
        <button type="submit" name="theme" value="deep" class="button theme-button theme-button--deep">Profond (Noir)</button>
    </form>
</div>

<script>
    async function loadTokens() {
        const listDiv = document.getElementById('token-list');
        try {
            const response = await fetch('{{ @base }}/auth/tokens');
            const data = await response.json();

            if (!data.tokens || data.tokens.length === 0) {
                listDiv.innerHTML = '<p class="text-muted">Aucun lien actif.</p>';
                return;
            }

            let html = '<ul class="token-list">';
            data.tokens.forEach(t => {
                const link = window.location.origin + '{{ @base }}/?token=' + t.token;
                html += `
                <li class="token-item">
                    <div class="token-info">
                        <input type="text" value="${link}" readonly onclick="this.select()" class="token-input">
                        <div class="token-meta">Créé le ${t.created_at}</div>
                    </div>
                    <div class="token-actions">
                        <button onclick="navigator.clipboard.writeText('${link}')" class="button token-button">Copier</button>
                        <button onclick="revokeToken('${t.token}')" class="button delete token-button">Supprimer</button>
                    </div>
                </li>
            `;
            });
            html += '</ul>';
            listDiv.innerHTML = html;

        } catch (e) {
            listDiv.innerHTML = '<p class="text-error">Erreur de chargement.</p>';
            console.error(e);
        }
    }

    async function generateToken() {
        const btn = document.getElementById('btn-generate-token');
        btn.disabled = true;
        btn.textContent = 'Génération...';

        try {
            const response = await fetch('{{ @base }}/auth/token/generate', {
                method: 'POST',
                headers: { 'X-CSRF-TOKEN': '{{ @csrfToken }}' }
            });
            if (!response.ok) throw new Error('Erreur');

            await loadTokens(); // Refresh list

        } catch (e) {
            alert('Erreur: ' + e.message);
        } finally {
            btn.disabled = false;
            btn.textContent = 'Générer un lien';
        }
    }

    async function revokeToken(token) {
        if (!confirm('Supprimer ce lien ?')) return;

        try {
            const response = await fetch('{{ @base }}/auth/token/revoke', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRF-TOKEN': '{{ @csrfToken }}'
                },
                body: JSON.stringify({ token: token })
            });

            if (!response.ok) throw new Error('Erreur');
            await loadTokens(); // Refresh list

        } catch (e) {
            alert('Impossible de supprimer: ' + e.message);
        }
    }

    // Initial load
    document.addEventListener('DOMContentLoaded', loadTokens);
</script>
