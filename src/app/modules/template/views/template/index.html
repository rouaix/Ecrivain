<div class="edit-page-layout">
    <div class="edit-header">
        <h2><i class="fas fa-layer-group"></i> Templates de projet</h2>
        <div class="header-actions">
            <a href="{{ @base }}/template/create" class="button primary" title="Créer un template">
                <i class="fas fa-plus"></i> Nouveau
            </a>
            <a href="{{ @base }}/template/import" class="button secondary" title="Importer un template JSON">
                <i class="fas fa-file-import"></i> Importer
            </a>
            <a href="{{ @base }}/dashboard" class="button" title="Retour au tableau de bord">
                <i class="fas fa-arrow-left"></i>
            </a>
        </div>
    </div>

    <check if="{{ isset(@SESSION.success) }}">
        <div class="alert-success">{{ @SESSION.success }}</div>
        <?php $f3->clear('SESSION.success'); ?>
    </check>

    <check if="{{ isset(@SESSION.error) }}">
        <div class="error edit-error">{{ @SESSION.error }}</div>
        <?php $f3->clear('SESSION.error'); ?>
    </check>

    <div class="edit-card">
        <div class="edit-card-section">
            <h3><i class="fas fa-info-circle"></i> A propos</h3>
            <p class="text-muted-para">
                Les templates definissent la structure de vos projets (ordre des sections, actes, chapitres, notes,
                etc.).
                Vous pouvez creer vos propres templates ou utiliser ceux fournis par defaut.
            </p>
        </div>

        <div class="edit-card-section">
            <h3><i class="fas fa-th-list"></i> Vos templates</h3>

            <check if="{{ !empty(@templates) }}">
                <true>
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Nom</th>
                                <th>Description</th>
                                <th>Type</th>
                                <th>Utilisation</th>
                                <th class="tpl-col-actions">Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            <repeat group="{{ @templates }}" value="{{ @tpl }}">
                                <tr>
                                    <td>
                                        <strong>{{ @tpl.name }}</strong>
                                        <check if="{{ @tpl.is_default }}">
                                            <span class="badge badge-secondary">Par defaut</span>
                                        </check>
                                    </td>
                                    <td class="text-muted-small">{{ @tpl.description | esc }}</td>
                                    <td>
                                        <check if="{{ @tpl.is_system }}">
                                            <true>
                                                <span class="badge">Systeme</span>
                                            </true>
                                            <false>
                                                <span class="badge badge-secondary">Personnalise</span>
                                            </false>
                                        </check>
                                    </td>
                                    <td>
                                        {{ @tpl.usage_count }} projet{{ (@tpl.usage_count > 1) ? 's' : '' }}
                                    </td>
                                    <td class="actions">
                                        <check if="{{ @tpl.can_edit }}">
                                            <true>
                                                <a href="{{ @base }}/template/{{ @tpl.id }}/edit" class="button small"
                                                    title="Editer">
                                                    <i class="fas fa-edit"></i>
                                                </a>
                                            </true>
                                            <false>
                                                <span class="button small disabled"
                                                    title="Template systeme non modifiable">
                                                    <i class="fas fa-lock"></i>
                                                </span>
                                            </false>
                                        </check>

                                        <a href="{{ @base }}/template/{{ @tpl.id }}/export" class="button small secondary"
                                            title="Exporter en JSON">
                                            <i class="fas fa-file-export"></i>
                                        </a>

                                        <check if="{{ @tpl.can_edit && !@tpl.is_system }}">
                                            <button type="button" class="button small secondary js-promote"
                                                title="Copier en template système" data-id="{{ @tpl.id }}"
                                                data-name="{{ @tpl.name | esc }}"
                                                data-description="{{ @tpl.description | esc }}">
                                                <i class="fas fa-arrow-up"></i>
                                            </button>
                                        </check>

                                        <check if="{{ @tpl.can_delete }}">
                                            <true>
                                                <a href="{{ @base }}/template/{{ @tpl.id }}/delete"
                                                    class="button small delete js-confirm" title="Supprimer"
                                                    data-confirm="Etes-vous sur de vouloir supprimer ce template ?">
                                                    <i class="fas fa-trash"></i>
                                                </a>
                                            </true>
                                            <false>
                                                <check if="{{ @tpl.usage_count > 0 }}">
                                                    <span class="button small disabled" title="Template en usage">
                                                        <i class="fas fa-trash"></i>
                                                    </span>
                                                </check>
                                            </false>
                                        </check>
                                    </td>
                                </tr>
                            </repeat>
                        </tbody>
                    </table>
                </true>
                <false>
                    <p class="empty-state">Aucun template disponible.</p>
                </false>
            </check>
        </div>
    </div>
</div>

<!-- Modale de promotion en template système -->
<div id="promoteModal" class="modal-overlay">
    <div class="modal-content">
        <div class="modal-header">
            <h3><i class="fas fa-arrow-up"></i> Copier en template système</h3>
            <button type="button" class="modal-close" id="closePromoteModal">&times;</button>
        </div>
        <form id="promoteForm" method="POST" action="">
            <input type="hidden" name="csrf_token" value="{{ @csrfToken }}">
            <div class="modal-body">
                <div class="form-group">
                    <label for="promoteFormName">Nom du template système</label>
                    <input type="text" id="promoteFormName" name="name" class="form-control" required>
                </div>
                <div class="form-group">
                    <label for="promoteFormDescription">Description</label>
                    <textarea id="promoteFormDescription" name="description" class="form-control" rows="3"></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="button secondary" id="cancelPromoteModal">Annuler</button>
                <button type="submit" class="button primary">Créer le template système</button>
            </div>
        </form>
    </div>
</div>

<script nonce="{{ @nonce }}">
    document.addEventListener('DOMContentLoaded', function () {
        var modal = document.getElementById('promoteModal');

        document.querySelectorAll('.js-confirm').forEach(function (link) {
            link.addEventListener('click', function (e) {
                var message = this.getAttribute('data-confirm') || 'Etes-vous sur ?';
                if (!confirm(message)) {
                    e.preventDefault();
                }
            });
        });

        document.querySelectorAll('.js-promote').forEach(function (btn) {
            btn.addEventListener('click', function () {
                var id = this.getAttribute('data-id');
                var defaultName = this.getAttribute('data-name') + ' (Système)';
                var description = this.getAttribute('data-description') || '';
                document.getElementById('promoteFormName').value = defaultName;
                document.getElementById('promoteFormDescription').value = description;
                document.getElementById('promoteForm').action = '{{ @base }}/template/' + id + '/promote';
                modal.classList.add('is-visible');
            });
        });

        function closeModal() {
            modal.classList.remove('is-visible');
        }

        document.getElementById('closePromoteModal').addEventListener('click', closeModal);
        document.getElementById('cancelPromoteModal').addEventListener('click', closeModal);
        modal.addEventListener('click', function (e) {
            if (e.target === modal) closeModal();
        });
    });
</script>