<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="robots" content="noindex">
    <title>{{ @title | esc }}</title>
    <link rel="stylesheet" href="{{ @base }}/public/style.css?v=28">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="{{ @base }}/public/theme-default.css">
    <style>
        .share-toolbar { display: flex; align-items: center; gap: .75rem; padding: .75rem 1rem; background: var(--header-bg, #3f51b5); color: var(--header-text, #fff); flex-wrap: wrap; position: sticky; top: 0; z-index: 100; }
        .share-toolbar-title { font-weight: 600; font-size: 1rem; flex: 1; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .share-toolbar a, .share-toolbar-badge { display: inline-flex; align-items: center; gap: .35rem; padding: .4rem .8rem; border-radius: 4px; font-size: .82rem; text-decoration: none; border: 1px solid rgba(255,255,255,.25); background: rgba(255,255,255,.1); color: #fff; }
        .share-toolbar-badge { background: rgba(255,193,7,.2); border-color: rgba(255,193,7,.4); cursor: default; }
        .share-readonly-notice { background: #fff8e1; border: 1px solid #ffe082; padding: .6rem 1rem; font-size: .85rem; color: #5d4037; text-align: center; }
        .review-body { display: flex; gap: 1.5rem; padding: 1rem; max-width: 1400px; margin: 0 auto; }
        .review-content { flex: 2; min-width: 0; }
        .review-panel { flex: 1; min-width: 280px; max-width: 380px; position: sticky; top: 56px; align-self: flex-start; max-height: calc(100vh - 80px); overflow-y: auto; background: var(--card-bg, #fff); border-radius: 8px; box-shadow: 0 1px 4px rgba(0,0,0,.1); padding: 1rem; }
        .review-panel-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: .75rem; }
        .review-panel-title { font-weight: 600; display: flex; align-items: center; gap: .4rem; }
        .review-panel-count { background: #3f51b5; color: #fff; border-radius: 12px; padding: .1rem .55rem; font-size: .8rem; }
        .review-filters { display: flex; gap: .3rem; flex-wrap: wrap; }
        .review-filter { border: none; border-radius: 4px; padding: .25rem .5rem; font-size: .8rem; cursor: pointer; background: #eee; }
        .review-filter.active { background: #3f51b5; color: #fff; }
        .ann-dot { display: inline-block; width: 10px; height: 10px; border-radius: 50%; }
        .ann-to_rewrite { background: #e53935; }
        .ann-inconsistency { background: #fdd835; }
        .ann-to_check { background: #fb8c00; }
        .ann-good { background: #43a047; }
        .annotation-card { background: var(--input-bg, #f5f5f5); border-radius: 6px; padding: .65rem .85rem; margin-bottom: .6rem; border-left: 3px solid #ccc; font-size: .85rem; display: none; }
        .annotation-card.visible { display: block; }
        .annotation-card.cat-to_rewrite { border-color: #e53935; }
        .annotation-card.cat-inconsistency { border-color: #fdd835; }
        .annotation-card.cat-to_check { border-color: #fb8c00; }
        .annotation-card.cat-good { border-color: #43a047; }
        .ann-selected-text { font-style: italic; color: #555; border-bottom: 1px solid #ddd; padding-bottom: .35rem; margin-bottom: .35rem; }
        .ann-comment { }
        .ann-meta { font-size: .75rem; color: #888; margin-top: .3rem; }
        .review-item { margin-bottom: 1.5rem; }
        .review-act-title { font-size: 1.4rem; color: #EF6C00; border-bottom: 2px solid #EF6C00; padding-bottom: .3rem; }
        .review-chapter-title { font-size: 1.1rem; }
        .review-text { line-height: 1.7; }
        /* Highlight annotations in text */
        .ann-highlight { border-radius: 2px; cursor: pointer; }
        .ann-highlight.cat-to_rewrite { background: rgba(229,57,53,.18); }
        .ann-highlight.cat-inconsistency { background: rgba(253,216,53,.35); }
        .ann-highlight.cat-to_check { background: rgba(251,140,0,.2); }
        .ann-highlight.cat-good { background: rgba(67,160,71,.18); }
        @media (max-width: 768px) { .review-body { flex-direction: column; } .review-panel { position: static; max-width: 100%; max-height: none; } }
    </style>
</head>
<body class="theme-default">

<div class="share-toolbar">
    <div class="share-toolbar-title"><i class="fas fa-glasses"></i> {{ @project.title | esc }}</div>
    <span class="share-toolbar-badge"><i class="fas fa-lock"></i> Lecture seule</span>
    <a href="{{ @base }}/s/{{ @token }}/{{ @project.id }}/lecture" title="Mode lecture"><i class="fas fa-book-open"></i></a>
    <a href="{{ @base }}/s/{{ @token }}/{{ @project.id }}/mindmap" title="Carte mentale"><i class="fas fa-project-diagram"></i></a>
    <a href="{{ @base }}/s/{{ @token }}" title="Retour"><i class="fas fa-arrow-left"></i></a>
</div>

<div class="share-readonly-notice">
    <i class="fas fa-info-circle"></i>
    Les annotations affichées appartiennent à l'auteur. Aucune modification n'est possible.
</div>

<div class="review-body">
    <!-- Content column -->
    <div class="review-content" id="reviewContent">
        <repeat group="{{ @items }}" value="{{ @item }}">
            <div class="review-item review-item-{{ @item.type }}">
                <check if="{{ @item.title }}">
                    <check if="{{ @item.type == 'act' }}">
                        <h2 class="review-act-title">{{ @item.title | esc }}</h2>
                    </check>
                    <check if="{{ @item.type != 'act' }}">
                        <h3 class="review-chapter-title">{{ @item.title | esc }}</h3>
                    </check>
                </check>
                <div class="review-text ql-editor"
                     data-content-id="{{ @item.id }}"
                     data-content-type="{{ @item.type }}"
                     id="content-{{ @item.type }}-{{ @item.id }}">
                    {{ @item.content | raw }}
                </div>
            </div>
        </repeat>
    </div>

    <!-- Annotations panel (read-only) -->
    <div class="review-panel" id="reviewPanel">
        <div class="review-panel-header">
            <div class="review-panel-title">
                <i class="fas fa-tags"></i> Annotations
                <span class="review-panel-count" id="annotationCount">0</span>
            </div>
            <div class="review-filters">
                <button class="review-filter active" data-filter="all">Tout</button>
                <button class="review-filter" data-filter="to_rewrite" title="À reformuler"><span class="ann-dot ann-to_rewrite"></span></button>
                <button class="review-filter" data-filter="inconsistency" title="Incohérence"><span class="ann-dot ann-inconsistency"></span></button>
                <button class="review-filter" data-filter="to_check" title="À vérifier"><span class="ann-dot ann-to_check"></span></button>
                <button class="review-filter" data-filter="good" title="Bon passage"><span class="ann-dot ann-good"></span></button>
            </div>
        </div>
        <div id="annotationsList"></div>
    </div>
</div>

<script nonce="{{ @nonce }}">
var annotations = {{ @annotationsJson | raw }};
var currentFilter = 'all';

function renderAnnotations() {
    var list = document.getElementById('annotationsList');
    list.innerHTML = '';
    var visible = 0;
    annotations.forEach(function(ann) {
        var card = document.createElement('div');
        card.className = 'annotation-card cat-' + ann.category;
        card.dataset.category = ann.category;
        card.dataset.contentType = ann.content_type;
        card.dataset.contentId = ann.content_id;

        var matches = (currentFilter === 'all' || ann.category === currentFilter);
        if (matches) { card.classList.add('visible'); visible++; }

        card.innerHTML =
            '<div class="ann-selected-text">&ldquo;' + escHtml(ann.selected_text) + '&rdquo;</div>' +
            '<div class="ann-comment">' + escHtml(ann.comment) + '</div>' +
            '<div class="ann-meta">' +
                '<span class="ann-dot ann-' + ann.category + '"></span> ' +
                escHtml(labelFor(ann.category)) +
            '</div>';

        card.addEventListener('click', function() {
            scrollToContent(ann.content_type, ann.content_id);
        });

        list.appendChild(card);
    });
    document.getElementById('annotationCount').textContent = visible;
    highlightAnnotations();
}

function escHtml(str) {
    return String(str || '').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}

function labelFor(cat) {
    var labels = {to_rewrite:'À reformuler', inconsistency:'Incohérence', to_check:'À vérifier', good:'Bon passage'};
    return labels[cat] || cat;
}

function scrollToContent(type, id) {
    var el = document.getElementById('content-' + type + '-' + id);
    if (el) el.scrollIntoView({behavior:'smooth', block:'center'});
}

function highlightAnnotations() {
    // Reset all highlights
    document.querySelectorAll('.review-text').forEach(function(el) {
        el.querySelectorAll('.ann-highlight').forEach(function(h) {
            h.outerHTML = h.innerHTML;
        });
    });

    annotations.forEach(function(ann) {
        if (currentFilter !== 'all' && ann.category !== currentFilter) return;
        var el = document.getElementById('content-' + ann.content_type + '-' + ann.content_id);
        if (!el || !ann.selected_text) return;
        highlightText(el, ann.selected_text, ann.category);
    });
}

function highlightText(container, text, category) {
    if (!container || !text) return;
    var walker = document.createTreeWalker(container, NodeFilter.SHOW_TEXT, null, false);
    var node;
    while ((node = walker.nextNode())) {
        var idx = node.nodeValue.indexOf(text);
        if (idx < 0) continue;
        var span = document.createElement('span');
        span.className = 'ann-highlight cat-' + category;
        span.textContent = text;
        var after = node.splitText(idx);
        after.nodeValue = after.nodeValue.substring(text.length);
        node.parentNode.insertBefore(span, after);
        return;
    }
}

// Filter buttons
document.querySelectorAll('.review-filter').forEach(function(btn) {
    btn.addEventListener('click', function() {
        document.querySelectorAll('.review-filter').forEach(function(b) { b.classList.remove('active'); });
        this.classList.add('active');
        currentFilter = this.dataset.filter;
        renderAnnotations();
    });
});

renderAnnotations();
</script>
</body>
</html>
