<div class="edit-page-layout">
    <div class="edit-header">
        <h2><i class="fas fa-share-alt"></i> Mes partages</h2>
        <div class="header-actions">
            <a href="{{ @base }}/share/create" class="button">
                <i class="fas fa-plus"></i> Nouveau lien
            </a>
        </div>
    </div>

    <check if="{{ empty(@links) }}">
        <p class="text-muted-para">Aucun lien de partage pour l'instant. Créez-en un pour partager vos projets en lecture seule.</p>
    </check>

    <repeat group="{{ @links }}" value="{{ @sl }}">
        <div class="share-link-card card">
            <div class="share-link-header">
                <strong>{{ @sl.label ?: 'Lien sans titre' | esc }}</strong>
                <span class="share-badge {{ @sl.is_active ? 'badge-active' : 'badge-inactive' }}" id="badge-{{ @sl.id }}">
                    {{ @sl.is_active ? 'Actif' : 'Inactif' }}
                </span>
            </div>

            <div class="share-link-url">
                <code id="url-{{ @sl.id }}">{{ @sl.public_url | esc }}</code>
                <button type="button" class="button secondary btn-copy" data-url="{{ @sl.public_url | esc }}" title="Copier le lien">
                    <i class="fas fa-copy"></i>
                </button>
                <a href="{{ @sl.public_url }}" target="_blank" class="button secondary" title="Ouvrir">
                    <i class="fas fa-external-link-alt"></i>
                </a>
            </div>

            <div class="share-link-projects">
                <small><i class="fas fa-book"></i>
                <repeat group="{{ @sl.projects }}" value="{{ @proj }}" counter="{{ @pcount }}">
                    <check if="{{ @pcount > 1 }}">, </check>{{ @proj.title | esc }}
                </repeat>
                <check if="{{ empty(@sl.projects) }}">Aucun projet associé</check>
                </small>
            </div>

            <div class="share-link-actions">
                <button type="button"
                        class="button secondary btn-toggle"
                        data-id="{{ @sl.id }}"
                        data-active="{{ @sl.is_active }}"
                        title="{{ @sl.is_active ? 'Désactiver' : 'Activer' }}">
                    <i class="fas {{ @sl.is_active ? 'fa-toggle-on' : 'fa-toggle-off' }}"></i>&nbsp;{{ @sl.is_active ? 'Désactiver' : 'Activer' }}
                </button>
                <a href="{{ @base }}/share/{{ @sl.id }}/edit" class="button secondary">
                    <i class="fas fa-edit"></i> Modifier
                </a>
                <form method="post" action="{{ @base }}/share/{{ @sl.id }}/delete" style="display:inline"
                      onsubmit="return confirm('Supprimer ce lien de partage ?')">
                    <input type="hidden" name="csrf_token" value="{{ @csrfToken }}">
                    <button type="submit" class="button danger">
                        <i class="fas fa-trash"></i>
                    </button>
                </form>
            </div>
        </div>
    </repeat>
</div>

<style>
.share-link-card { padding: 1rem 1.25rem; margin-bottom: 1rem; border-radius: 8px; }
.share-link-header { display: flex; align-items: center; gap: .75rem; margin-bottom: .5rem; font-size: 1.05rem; }
.share-badge { font-size: .75rem; padding: .2rem .6rem; border-radius: 12px; font-weight: 600; }
.badge-active { background: #d4edda; color: #155724; }
.badge-inactive { background: #f8d7da; color: #721c24; }
.share-link-url { display: flex; align-items: center; gap: .5rem; margin-bottom: .5rem; flex-wrap: wrap; }
.share-link-url code { font-size: .8rem; background: var(--input-bg, #f5f5f5); padding: .2rem .5rem; border-radius: 4px; word-break: break-all; flex: 1; min-width: 0; }
.share-link-projects { margin-bottom: .75rem; color: var(--text-muted, #666); }
.share-link-actions { display: flex; gap: .5rem; flex-wrap: wrap; }
</style>

<script nonce="{{ @nonce }}">
document.querySelectorAll('.btn-copy').forEach(btn => {
    btn.addEventListener('click', function() {
        navigator.clipboard.writeText(this.dataset.url).then(() => {
            const orig = this.innerHTML;
            this.innerHTML = '<i class="fas fa-check"></i>';
            setTimeout(() => this.innerHTML = orig, 1500);
        });
    });
});

document.querySelectorAll('.btn-toggle').forEach(btn => {
    btn.addEventListener('click', function() {
        const id = this.dataset.id;
        fetch('{{ @base }}/share/' + id + '/toggle', {
            method: 'POST',
            headers: {
                'X-CSRF-TOKEN': document.querySelector('meta[name="csrf-token"]').content,
                'Content-Type': 'application/json'
            }
        })
        .then(r => r.json())
        .then(data => {
            const active = data.is_active;
            const badge  = document.getElementById('badge-' + id);
            badge.textContent  = active ? 'Actif' : 'Inactif';
            badge.className    = 'share-badge ' + (active ? 'badge-active' : 'badge-inactive');
            this.dataset.active = active;
            this.innerHTML = active
                ? '<i class="fas fa-toggle-on"></i>&nbsp;Désactiver'
                : '<i class="fas fa-toggle-off"></i>&nbsp;Activer';
        });
    });
});
</script>
