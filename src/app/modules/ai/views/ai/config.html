<h2>Configuration IA</h2>

<div class="ai-config-card">
    <check if="{{ @success }}">
        <div class="alert-success alert-success--wide">
            Configuration enregistrée avec succès.
        </div>
    </check>

    <form action="{{ @base }}/ai/config" method="post">

        <div class="ai-config-section">
            <div class="form-group">
                <label for="provider" class="ai-config-label">Fournisseur IA</label>
                <select id="provider" name="provider"
                    class="ai-config-input"
                    onchange="updateModels()">
                    <option value="openai" {{@config.provider=='openai' ?'selected':''}}>OpenAI</option>
                    <option value="gemini" {{@config.provider=='gemini' ?'selected':''}}>Google Gemini</option>
                    <option value="mistral" {{@config.provider=='mistral' ?'selected':''}}>Mistral AI</option>
                    <option value="anthropic" {{@config.provider=='anthropic' ?'selected':''}}>Anthropic (Claude)
                    </option>
                </select>
            </div>

            <div class="form-group form-group--mt-15">
                <label for="api_key" class="ai-config-label">Clé API</label>
                <input type="password" id="api_key" name="api_key" value="{{ @config.api_key }}"
                    class="ai-config-input" placeholder="sk-...">
                <small class="text-muted">La clé ne sera pas affichée après enregistrement pour sécurité.</small>
            </div>

            <div class="form-group form-group--mt-15">
                <label for="model" class="ai-config-label">Modèle</label>
                <select id="model" name="model"
                    class="ai-config-input">
                    <!-- Populated by JS -->
                </select>
            </div>
        </div>

        <script>
            const models = {{ json_encode(@models) | raw }};
            const currentModel = "{{ @config.model }}";

            function updateModels() {
                const provider = document.getElementById('provider').value;
                const modelSelect = document.getElementById('model');
                modelSelect.innerHTML = '';

                const providerModels = models[provider] || [];
                providerModels.forEach(m => {
                    const opt = document.createElement('option');
                    opt.value = m;
                    opt.textContent = m;
                    if (m === currentModel) opt.selected = true;
                    modelSelect.appendChild(opt);
                });
            }

            // Init
            document.addEventListener('DOMContentLoaded', updateModels);
        </script>

        <div class="form-group">
            <label for="system" class="ai-config-label">Rôle Système (Instructions
                Globales)</label>
            <textarea id="system" name="system" rows="3"
                class="ai-config-input">{{ @config.system }}</textarea>
            <small class="text-muted">Définit la personnalité et le comportement général de l'IA.</small>
        </div>

        <div class="form-group form-group--mt-20">
            <label for="continue" class="ai-config-label">Consigne
                "Continuer"</label>
            <textarea id="continue" name="continue" rows="3"
                class="ai-config-input">{{ @config.continue }}</textarea>
            <small class="text-muted">Instructions ajoutées lors de la demande de continuation de texte.</small>
        </div>

        <div class="form-group form-group--mt-20">
            <label for="rephrase" class="ai-config-label">Consigne
                "Reformuler"</label>
            <textarea id="rephrase" name="rephrase" rows="3"
                class="ai-config-input">{{ @config.rephrase }}</textarea>
            <small class="text-muted">Instructions ajoutées lors de la demande de reformulation.</small>
        </div>

        <div class="form-group form-group--mt-20">
            <label for="summarize_chapter" class="ai-config-label">Consigne "Résumé
                Chapitre"</label>
            <textarea id="summarize_chapter" name="summarize_chapter" rows="3"
                class="ai-config-input">{{ @config.summarize_chapter }}</textarea>
            <small class="text-muted">Instructions pour la génération du résumé d'un chapitre (basé sur ses
                sous-chapitres).</small>
        </div>

        <div class="form-group form-group--mt-20">
            <label for="summarize_act" class="ai-config-label">Consigne "Résumé
                Acte"</label>
            <textarea id="summarize_act" name="summarize_act" rows="3"
                class="ai-config-input">{{ @config.summarize_act }}</textarea>
            <small class="text-muted">Instructions pour la génération du résumé d'un acte (basé sur les résumés de ses
                chapitres).</small>
        </div>

        <div class="ai-config-actions">
            <button type="submit" class="button primary ai-config-save">Enregistrer</button>
            <a href="{{ @base }}/dashboard" class="button secondary ai-config-back">Retour</a>
        </div>
    </form>
</div>
