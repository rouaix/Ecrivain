<h2>Configuration IA</h2>

<div class="ai-config-card">
    <check if="{{ @success }}">
        <div class="alert-success alert-success--wide">
            Configuration enregistrée avec succès.
        </div>
    </check>

    <form action="{{ @base }}/ai/config" method="post">

        <div class="ai-config-section">
            <div class="form-group">
                <label for="provider" class="ai-config-label">Fournisseur IA</label>
                <select id="provider" name="provider"
                    class="ai-config-input"
                    onchange="updateModels()">
                    <option value="openai" {{@config.provider=='openai' ?'selected':''}}>OpenAI</option>
                    <option value="gemini" {{@config.provider=='gemini' ?'selected':''}}>Google Gemini</option>
                    <option value="mistral" {{@config.provider=='mistral' ?'selected':''}}>Mistral AI</option>
                    <option value="anthropic" {{@config.provider=='anthropic' ?'selected':''}}>Anthropic (Claude)
                    </option>
                </select>
            </div>

            <div class="form-group form-group--mt-15">
                <label for="api_key" class="ai-config-label">Clé API</label>
                <input type="password" id="api_key" name="api_key" value="{{ @config.api_key }}"
                    class="ai-config-input" placeholder="sk-...">
                <small class="text-muted">La clé ne sera pas affichée après enregistrement pour sécurité.</small>
            </div>

            <div class="form-group form-group--mt-15">
                <label for="model" class="ai-config-label">Modèle</label>
                <select id="model" name="model"
                    class="ai-config-input">
                    <!-- Populated by JS -->
                </select>
            </div>
        </div>

        <script>
            const models = {{ json_encode(@models) | raw }};
            const currentModel = "{{ @config.model }}";

            function updateModels() {
                const provider = document.getElementById('provider').value;
                const modelSelect = document.getElementById('model');
                modelSelect.innerHTML = '';

                const providerModels = models[provider] || [];
                providerModels.forEach(m => {
                    const opt = document.createElement('option');
                    opt.value = m;
                    opt.textContent = m;
                    if (m === currentModel) opt.selected = true;
                    modelSelect.appendChild(opt);
                });
            }

            // Init
            document.addEventListener('DOMContentLoaded', updateModels);
        </script>

        <div class="form-group">
            <label for="system" class="ai-config-label">Rôle Système (Instructions
                Globales)</label>
            <textarea id="system" name="system" rows="3"
                class="ai-config-input">{{ @config.system }}</textarea>
            <small class="text-muted">Définit la personnalité et le comportement général de l'IA.</small>
        </div>

        <div class="form-group form-group--mt-20">
            <label for="continue" class="ai-config-label">Consigne
                "Continuer"</label>
            <textarea id="continue" name="continue" rows="3"
                class="ai-config-input">{{ @config.continue }}</textarea>
            <small class="text-muted">Instructions ajoutées lors de la demande de continuation de texte.</small>
        </div>

        <div class="form-group form-group--mt-20">
            <label for="rephrase" class="ai-config-label">Consigne
                "Reformuler"</label>
            <textarea id="rephrase" name="rephrase" rows="3"
                class="ai-config-input">{{ @config.rephrase }}</textarea>
            <small class="text-muted">Instructions ajoutées lors de la demande de reformulation.</small>
        </div>

        <div class="form-group form-group--mt-20">
            <label for="summarize_chapter" class="ai-config-label">Consigne "Résumé
                Chapitre"</label>
            <textarea id="summarize_chapter" name="summarize_chapter" rows="3"
                class="ai-config-input">{{ @config.summarize_chapter }}</textarea>
            <small class="text-muted">Instructions pour la génération du résumé d'un chapitre (basé sur ses
                sous-chapitres).</small>
        </div>

        <div class="form-group form-group--mt-20">
            <label for="summarize_act" class="ai-config-label">Consigne "Résumé
                Acte"</label>
            <textarea id="summarize_act" name="summarize_act" rows="3"
                class="ai-config-input">{{ @config.summarize_act }}</textarea>
            <small class="text-muted">Instructions pour la génération du résumé d'un acte (basé sur les résumés de ses
                chapitres).</small>
        </div>

        <div class="form-group form-group--mt-20">
            <label class="ai-config-label">Prompts personnalisés</label>
            <div id="customPromptsList">
                <repeat group="{{ @config.custom_prompts }}" value="{{ @p }}">
                    <div class="ai-custom-prompt-row">
                        <input type="text" name="custom_prompt_label[]" class="ai-config-input"
                            placeholder="Titre à afficher" value="{{ @p.label | esc }}">
                        <textarea name="custom_prompt_value[]" rows="3" class="ai-config-input"
                            placeholder="Consigne / prompt">{{ @p.prompt | esc }}</textarea>
                        <button type="button" class="button small delete ai-custom-prompt-remove">Supprimer</button>
                    </div>
                </repeat>
            </div>
            <div class="">
                <button type="button" class="button small" id="addCustomPrompt">+ Ajouter un prompt</button>
            </div>
            <small class="text-muted">Ces prompts apparaissent dans la liste de choix du prompt utilisateur.</small>
        </div>

        <div class="ai-config-actions">
            <button type="submit" class="button primary ai-config-save">Enregistrer</button>
            <a href="{{ @base }}/dashboard" class="button secondary ai-config-back">Retour</a>
        </div>
    </form>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        const list = document.getElementById('customPromptsList');
        const addBtn = document.getElementById('addCustomPrompt');

        function addRow(label = '', prompt = '') {
            const row = document.createElement('div');
            row.className = 'ai-custom-prompt-row';

            const input = document.createElement('input');
            input.type = 'text';
            input.name = 'custom_prompt_label[]';
            input.className = 'ai-config-input';
            input.placeholder = 'Titre a afficher';
            input.value = label;

            const textarea = document.createElement('textarea');
            textarea.name = 'custom_prompt_value[]';
            textarea.rows = 3;
            textarea.className = 'ai-config-input';
            textarea.placeholder = 'Consigne / prompt';
            textarea.value = prompt;

            const remove = document.createElement('button');
            remove.type = 'button';
            remove.className = 'button small delete ai-custom-prompt-remove';
            remove.textContent = 'Supprimer';

            row.appendChild(input);
            row.appendChild(textarea);
            row.appendChild(remove);
            list.appendChild(row);
        }

        if (addBtn) {
            addBtn.addEventListener('click', function () {
                addRow();
            });
        }

        if (list) {
            list.addEventListener('click', function (e) {
                const target = e.target;
                if (target && target.classList.contains('ai-custom-prompt-remove')) {
                    const row = target.closest('.ai-custom-prompt-row');
                    if (row) {
                        row.remove();
                    }
                }
            });
        }
    });
</script>
